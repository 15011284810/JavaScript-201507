<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style type="text/css">
        #div1 {
            width: 100px;
            height: 100px;
            background: red;
            position: absolute;
        }
    </style>
</head>
<body>
<div id="div1"></div>
<script type="text/javascript" src="event.js"></script>
<script type="text/javascript">

    function EventEmitter() {}
        EventEmitter.prototype.on = function (type, fn) {
            if (!this[type]) {
                this[type] = [];
            }
            var a = this[type];
            for (var i = 0; i < a.length; i++) {
                if (a[i] == fn)return;
            }
            a.push(fn);
        };
        EventEmitter.prototype.run = function (type) {//通知
            var a = this[type];
            if (a) {
                for (var i = 0; i < a.length; i++) {
                    if (typeof a[i] == "function")
                        a[i].call(this);
                }
            }
        };
        EventEmitter.prototype.off = function (type, fn) {
            var a = this["aEvent" + type];
            if (a) {
                for (var i = 0; i < a.length; i++) {
                    if (a[i] == fn) {
                        a[i] = null;
                        return;
                    }

                }
            }
        };


    function Drag(ele) {
        this.ele = ele;//这是做了一个保存的动作
        this.x = null;//this.x=this.ele.offsetLeft;
        this.y = null;
        this.mx = null;
        this.my = null;
        this.DOWN = processThis(this, this.down);
        this.MOVE = processThis(this, this.move);
        this.UP = processThis(this, this.up);
        on(ele, "mousedown", this.DOWN);
        this.run("mousedown",Drag);
    }

    Drag.prototype = new EventEmitter;
    //或者使用Drag.prototype.__proto__=new EventEmitter;
    Drag.prototype.down = function (e) {
        this.x = this.ele.offsetLeft;
        this.y = this.ele.offsetTop;
        this.mx = e.pageX;
        this.my = e.pageY;
        if (this.ele.setCapture) {
            on(this.ele, "mousemove", this.MOVE);
            on(this.ele, "mouseup", this.UP);
            this.ele.setCapture();
        } else {
            on(document, "mousemove", this.MOVE);
            on(document, "mouseup", this.UP);
        }
        e.preventDefault();
        this.run(this.ele,"drag",e);
    };

    Drag.prototype.move = function (e) {
        this.ele.style.left = this.x + e.pageX - this.mx + "px";
        this.ele.style.top = this.y + e.pageY - this.my + "px";
    };

    Drag.prototype.up = function (e) {
        if (this.ele.releaseCapture) {
            this.ele.releaseCapture();
            off(this.ele, "mousemove", this.MOVE);
            off(this.ele, "mouseup", this.UP);
        } else {
            off(document, "mousemove", this.MOVE);
            off(document, "mouseup", this.UP);
        }
        this.run(this.ele,"dragend",e);
    };
   var obj= new Drag(div1);

    function addBorder(){
        obj.style.border="2px solid #ccc";
    }
    function border(){
        this.on(this.ele,"addborder",addBorder);
    }

    //借用构造函数继承；Person.call(this,name,age,gender);在函数体内运行，就会继承父函数的方法；
    on(obj,"mousedown",down);
    on(obj,"addborder",border);
    on(obj,"dragstart",clearEffect);
    on(obj,"drag",getSpeed);
    on(obj,"dragend",drop);
    on(obj,"dragend",fly);

    //速度效果
   function cleatEffect(){
       clearTimeout(this.flyTimer);
       clearTimeout(this.dropTimer);

   }

    function getSpeed(){
        if(!this.prevPosi){
            this.prevPosi=this.offsetLeft;
        }else{
            this.speed=this.offsetLeft-this.prevPosi;
            this.prevPosi=this.offsetLeft;
        }
    }

    function fly(){
        this.speed*=0.97;
        var val=this.offsetLeft+this.speed;
        var rightMax=document.documentElement.clientWidth-this.offsetWidth;
        if(val<=0){
            this.style.left=0+"px";
            this.speed*=-1;
        }else if(val>=rightMax){
            this.style.left=rightMax+"px";
            this.speed*=-1;
        }else{
            this.style.left=val+"px";
        }
        if(Math.abs(this.speed)>=0.5){
            this.flyTimer=setTimeout(fly.bind(this),30)}
    }

    var count=0;
    function drop(){
        if(!this.dropSpeed){
            this.dropSpeed=9;
        }else {
            this.dropSpeed+=9;
        }
        this.dropSpeed *=0.97;
        var maxBottom=document.documentElement.clientHeight-this.offsetHeight;
        var val =this.offsetTop+this.dropSpeed ;
        if(val>=maxBottom){
            this.style.top=maxBottom+'px';
            this.dropSpeed*=-1;
            count++;
        }else{
            this.style.top=val+'px';
            count=0;
        }

        if(count<2)
            this.dropTimer= window.setTimeout(drop.bind(this),20);
    }
</script>
</body>
</html>